---
title: "2. Demanda Escolar"
author: "GPF"
date: '2022-06-11'
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(kableExtra)
```

```{r oferta}

# Regular

a1_18 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2018/A1_Oferta_Establecimientos_etapa_regular_2018_Admision_2019.csv")

a1_19 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2019/A1_Oferta_Establecimientos_etapa_regular_2019_Admision_2020.csv")

a1_20 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2020/A1_Oferta_Establecimientos_etapa_regular_2020_Admision_2021.csv")

a1_21 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2021/A1_Oferta_Establecimientos_etapa_regular_2021_Admision_2022.csv")

# Complementaria

a2_18 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2018/A2_Oferta_Establecimientos_etapa_complementaria_2018_Admision_2019.csv")

a2_19 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2019/A2_Oferta_Establecimientos_etapa_complementaria_2019_Admision_2020.csv")

a2_20 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2020/A2_Oferta_Establecimientos_etapa_complementaria_2020_Admision_2021.csv")

a2_21 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2021/A2_Oferta_Establecimientos_etapa_complementaria_2021_Admision_2022.csv")
```

```{r postulantes}

# Regular

b1_18 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2018/B1_Postulantes_etapa_regular_2018_Admision_2019_PUBL.csv")

b1_19 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2019/B1_Postulantes_etapa_regular_2019_Admision_2020_PUBL.csv")

b1_20 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2020/B1_Postulantes_etapa_regular_2020_Admision_2021_PUBL.csv")

b1_21 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2021/B1_Postulantes_etapa_regular_2021_Admision_2022_PUBL.csv")

# Complementaria

b2_18 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2018/B2_Postulantes_etapa_complementaria_2018_Admision_2019_PUBL.csv")

b2_19 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2019/B2_Postulantes_etapa_complementaria_2019_Admision_2020_PUBL.csv")

b2_20 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2020/B2_Postulantes_etapa_complementaria_2020_Admision_2021_PUBL.csv")

b2_21 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2021/B2_Postulantes_etapa_complementaria_2021_Admision_2022_PUBL.csv")
```

```{r postulaciones}

# Regular

c1_18 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2018/C1_Postulaciones_etapa_regular_2018_Admision_2019_PUBL.csv")

c1_19 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2019/C1_Postulaciones_etapa_regular_2019_Admision_2020_PUBL.csv")

c1_20 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2020/C1_Postulaciones_etapa_regular_2020_Admision_2021_PUBL.csv")

c1_21 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2021/C1_Postulaciones_etapa_regular_2021_Admision_2022_PUBL.csv")

# Complementaria

c2_18 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2018/C2_Postulaciones_etapa_complementaria_2018_Admision_2019_PUBL.csv")

c2_19 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2019/C2_Postulaciones_etapa_complementaria_2019_Admision_2020_PUBL.csv")

c2_20 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2020/C2_Postulaciones_etapa_complementaria_2020_Admision_2021_PUBL.csv")

c2_21 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2021/C2_Postulaciones_etapa_complementaria_2021_Admision_2022_PUBL.csv")
```

```{r resultados}

# Regular

d1_18 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2018/D1_Resultados_etapa_regular_2018_Admision_2019_PUBL.csv")

d1_19 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2019/D1_Resultados_etapa_regular_2019_Admision_2020_PUBL.csv")

d1_20 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2020/D1_Resultados_etapa_regular_2020_Admision_2021_PUBL.csv")

d1_21 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2021/D1_Resultados_etapa_regular_2021_Admision_2022_PUBL.csv")

# Complementaria

d2_18 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2018/D2_Resultados_etapa_complementaria_2018_Admision_2019_PUBL.csv")

d2_19 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2019/D2_Resultados_etapa_complementaria_2019_Admision_2020_PUBL.csv")

d2_20 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2020/D2_Resultados_etapa_complementaria_2020_Admision_2021_PUBL.csv")

d2_21 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2021/D2_Resultados_etapa_complementaria_2021_Admision_2022_PUBL.csv")
```

## Bases

a = oferta establecimientos b = postulantes c = postulaciones d = resultados

## Oferta Establecimientos

```{r mat18}
# Caso unico para rbd (primero)

a1_18 <- a1_18%>%
  mutate(
    unico = duplicated(a1_18$rbd),
    unico = ifelse(unico == FALSE, 1, 0))

# Agregacion de variables para caracterizar el establecimiento educativo segun rbd

mat18 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/Resumen de matrícula por establecimiento/Resumen-matricula-EE-2018/Resumen_Matricula_EE_Oficial_2018.csv")

mat18 <- mat18%>%
  mutate(
    region = ifelse(NOM_COM_RBD == 'BULNES'|
NOM_COM_RBD == 'CHILLAN'|
NOM_COM_RBD == 'CHILLAN VIEJO'|
NOM_COM_RBD == 'COBQUECURA'|
NOM_COM_RBD == 'COELEMU'|
NOM_COM_RBD == 'COIHUECO'|
NOM_COM_RBD == 'EL CARMEN'|
NOM_COM_RBD == 'NINHUE'|
NOM_COM_RBD == 'ÑIQUEN'|
NOM_COM_RBD == 'PEMUCO'|
NOM_COM_RBD == 'PINTO'|
NOM_COM_RBD == 'PORTEZUELO'|
NOM_COM_RBD == 'QUILLON'|
NOM_COM_RBD == 'QUIRIHUE'|
NOM_COM_RBD == 'RANQUIL'|
NOM_COM_RBD == 'SAN CARLOS'|
NOM_COM_RBD == 'SAN FABIAN'|
NOM_COM_RBD == 'SAN IGNACIO'|
NOM_COM_RBD == 'SAN NICOLAS'|
NOM_COM_RBD == 'TREHUACO'|
NOM_COM_RBD == 'YUNGAY', 16, COD_REG_RBD))

mat18 <- mat18 %>%
  select(RBD, COD_DEPE2, RURAL_RBD, COD_REG_RBD, region)%>%
  rename(rbd = RBD, dep = COD_DEPE2, zona = RURAL_RBD)

oferta18 <- left_join(a1_18, mat18, by = 'rbd')

oferta18 <- oferta18 %>%
  mutate(
    dep = ifelse(dep == 1 | dep == 5, 0,1)
  )

oferta18%>%
  filter(unico == 1)%>%
  count(
    region
  )
```

```{r caracterizacion2018}
#Caracterizacion oferta 2018

car18 <- rbind(
oferta18 %>%
  filter(unico == 1)%>%
  count(cod_jor)%>%
  mutate(
    prop = round(n/sum(n),3) * 100
  )%>%
  rename(var = cod_jor),

oferta18 %>%
  filter(unico == 1)%>%
  count(con_copago)%>%
  mutate(
    prop = round(n/sum(n),3) * 100
  )%>%
  rename(var = con_copago),

oferta18 %>%
  filter(unico == 1)%>%
  count(dep)%>%
  mutate(
    prop = round(n/sum(n),3) * 100
  )%>%
  rename(var = dep),

oferta18 %>%
  filter(unico == 1)%>%
  count(zona)%>%
  mutate(
    prop = round(n/sum(n),3) * 100
  )%>%
  rename(var = zona),

oferta18 %>%
  filter(unico == 1)%>%
  count(region)%>%
  mutate(
    prop = round(n/sum(n),3) * 100
  )%>%
  rename(var = region))

car18 <- dplyr::add_row(
  car18,
  var = 13,
  n = 0,
  prop = 0,
  .before = 22
)
```

0 publico 1 privado 0 urbano 1 rural

```{r mat19}
# Caso unico para rbd (primero)
a1_19 <- a1_19%>%
  mutate(
    unico = duplicated(a1_19$rbd),
    unico = ifelse(unico == FALSE, 1, 0))

# Agregacion de variables para caracterizar el establecimiento educativo segun rbd

mat19 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/Resumen de matrícula por establecimiento/Resumen-matricula-EE-2019/Resumen_Matricula_EE_Oficial_2019.csv")

mat19 <- mat19 %>%
  select(RBD, COD_DEPE2, RURAL_RBD, COD_REG_RBD)%>%
  rename(rbd = RBD, dep = COD_DEPE2, zona = RURAL_RBD, region = COD_REG_RBD)

oferta19 <- left_join(a1_19, mat19, by = 'rbd')

oferta19 <- oferta19 %>%
  mutate(
    dep = ifelse(dep == 1 | dep == 5, 0,1)
  )
```

```{r caracterizacion2019}
#Caracterizacion oferta 2019
apply((oferta18%>%
           filter(unico == 1)%>%
  select(cod_jor, con_copago, dep, zona, region)), 2, table)

car19 <- rbind(
oferta19 %>%
  filter(unico == 1)%>%
  count(cod_jor)%>%
  mutate(
    prop = round(n/sum(n),3) * 100
  )%>%
  rename(var = cod_jor),

oferta19 %>%
  filter(unico == 1)%>%
  count(con_copago)%>%
  mutate(
    prop = round(n/sum(n),3) * 100
  )%>%
  rename(var = con_copago),

oferta19 %>%
  filter(unico == 1)%>%
  count(dep)%>%
  mutate(
    prop = round(n/sum(n),3) * 100
  )%>%
  rename(var = dep),

oferta19 %>%
  filter(unico == 1)%>%
  count(zona)%>%
  mutate(
    prop = round(n/sum(n),3) * 100
  )%>%
  rename(var = zona),

oferta19 %>%
  filter(unico == 1)%>%
  count(region)%>%
  mutate(
    prop = round(n/sum(n),3) * 100
  )%>%
  rename(var = region))
```

```{r mat20}
# Caso unico para rbd (primero)
a1_20 <- a1_20%>%
  mutate(
    unico = duplicated(a1_20$rbd),
    unico = ifelse(unico == FALSE, 1, 0))

# Agregacion de variables para caracterizar el establecimiento educativo segun rbd

mat20 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/Resumen de matrícula por establecimiento/Resumen-matricula-EE-2020/Resumen_Matricula_EE_Oficial_2020.csv")

mat20 <- mat20 %>%
  select(RBD, COD_DEPE2, RURAL_RBD, COD_REG_RBD)%>%
  rename(rbd = RBD, dep = COD_DEPE2, zona = RURAL_RBD, region = COD_REG_RBD)

oferta20 <- left_join(a1_20, mat20, by = 'rbd')

oferta20 <- oferta20 %>%
  mutate(
    dep = ifelse(dep == 1 | dep == 5, 0,1)
  )
```

```{r caracterizacion2020}
#Caracterizacion oferta 2019
apply((oferta18%>%
           filter(unico == 1)%>%
  select(cod_jor, con_copago, dep, zona, region)), 2, table)

car20 <- rbind(
oferta20 %>%
  filter(unico == 1)%>%
  count(cod_jor)%>%
  mutate(
    prop = round(n/sum(n),3) * 100
  )%>%
  rename(var = cod_jor),

oferta20 %>%
  filter(unico == 1)%>%
  count(con_copago)%>%
  mutate(
    prop = round(n/sum(n),3) * 100
  )%>%
  rename(var = con_copago),

oferta20 %>%
  filter(unico == 1)%>%
  count(dep)%>%
  mutate(
    prop = round(n/sum(n),3) * 100
  )%>%
  rename(var = dep),

oferta20 %>%
  filter(unico == 1)%>%
  count(zona)%>%
  mutate(
    prop = round(n/sum(n),3) * 100
  )%>%
  rename(var = zona),

oferta20 %>%
  filter(unico == 1)%>%
  count(region)%>%
  mutate(
    prop = round(n/sum(n),3) * 100
  )%>%
  rename(var = region))
```

```{r mat21}
# Caso unico para rbd (primero)
a1_21 <- a1_21%>%
  mutate(
    unico = duplicated(a1_21$rbd),
    unico = ifelse(unico == FALSE, 1, 0))

# Agregacion de variables para caracterizar el establecimiento educativo segun rbd

mat21 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/Resumen de matrícula por establecimiento/Resumen-matricula-EE-2021/Resumen_Matricula_EE_Oficial_2021.csv")

mat21 <- mat21 %>%
  select(RBD, COD_DEPE2, RURAL_RBD, COD_REG_RBD)%>%
  rename(rbd = RBD, dep = COD_DEPE2, zona = RURAL_RBD, region = COD_REG_RBD)

oferta21 <- left_join(a1_21, mat21, by = 'rbd')

oferta21 <- oferta21 %>%
  mutate(
    dep = ifelse(dep == 1 | dep == 5, 0,1)
  )
```

```{r caracterizacion2021}
#Caracterizacion oferta 2019
apply((oferta18%>%
           filter(unico == 1)%>%
  select(cod_jor, con_copago, dep, zona, region)), 2, table)

car21 <- rbind(
oferta21 %>%
  filter(unico == 1)%>%
  count(cod_jor)%>%
  mutate(
    prop = round(n/sum(n),3) * 100
  )%>%
  rename(var = cod_jor),

oferta21 %>%
  filter(unico == 1)%>%
  count(con_copago)%>%
  mutate(
    prop = round(n/sum(n),3) * 100
  )%>%
  rename(var = con_copago),

oferta21 %>%
  filter(unico == 1)%>%
  count(dep)%>%
  mutate(
    prop = round(n/sum(n),3) * 100
  )%>%
  rename(var = dep),

oferta21 %>%
  filter(unico == 1)%>%
  count(zona)%>%
  mutate(
    prop = round(n/sum(n),3) * 100
  )%>%
  rename(var = zona),

oferta21 %>%
  filter(unico == 1)%>%
  count(region)%>%
  mutate(
    prop = round(n/sum(n),3) * 100
  )%>%
  rename(var = region))
```

```{r datos_caracterizacion}
car_ee <- dplyr::bind_cols(
  car18,car19$n,car19$prop,car20$n,car20$prop,car21$n,car21$prop)

car_ee <- car_ee%>%
  rename(
    n18 = n,
    prop18 = prop,
    n19 = ...4,
    prop19 = ...5,
    n20 = ...6,
    prop20 = ...7,
    n21 = ...8,
    prop21 = ...9)

kable(car_ee)%>%
  kable_styling()

#write.csv(car_ee,"C:/Users/geral/OneDrive - University of Iowa/PhD portfolio/1.-Research/2. Sistema de Admisión Escolar/car_ee.csv", row.names = FALSE)
```

```{r}
pos18 <- rbind(b1_18%>%
  count(cod_nivel)%>%
  mutate(
    prop = round(n/sum(n),3)*100
  )%>%
  rename(var = cod_nivel),

b1_18%>%
  count(es_mujer)%>%
  mutate(
    prop = round(n/sum(n),3)*100
  )%>%
  rename(var = es_mujer),

b1_18%>%
  count(prioritario)%>%
  mutate(
    prop = round(n/sum(n),3)*100
  )%>%
  rename(var = prioritario),

b1_18%>%
  count(alto_rendimiento)%>%
  mutate(
    prop = round(n/sum(n),3)*100
  )%>%
  rename(var = alto_rendimiento))

# 2019

pos19 <- rbind(b1_19%>%
  count(cod_nivel)%>%
  mutate(
    prop = round(n/sum(n),3)*100
  )%>%
  rename(var = cod_nivel),

b1_19%>%
  count(es_mujer)%>%
  mutate(
    prop = round(n/sum(n),3)*100
  )%>%
  rename(var = es_mujer),

b1_19%>%
  count(prioritario)%>%
  mutate(
    prop = round(n/sum(n),3)*100
  )%>%
  rename(var = prioritario),

b1_19%>%
  count(alto_rendimiento)%>%
  mutate(
    prop = round(n/sum(n),3)*100
  )%>%
  rename(var = alto_rendimiento))

pos20 <- rbind(b1_20%>%
  count(cod_nivel)%>%
  mutate(
    prop = round(n/sum(n),3)*100
  )%>%
  rename(var = cod_nivel),

b1_20%>%
  count(es_mujer)%>%
  mutate(
    prop = round(n/sum(n),3)*100
  )%>%
  rename(var = es_mujer),

b1_20%>%
  count(prioritario)%>%
  mutate(
    prop = round(n/sum(n),3)*100
  )%>%
  rename(var = prioritario),

b1_20%>%
  count(alto_rendimiento)%>%
  mutate(
    prop = round(n/sum(n),3)*100
  )%>%
  rename(var = alto_rendimiento))

pos21 <- rbind(b1_21%>%
  count(cod_nivel)%>%
  mutate(
    prop = round(n/sum(n),3)*100
  )%>%
  rename(var = cod_nivel),

b1_21%>%
  count(es_mujer)%>%
  mutate(
    prop = round(n/sum(n),3)*100
  )%>%
  rename(var = es_mujer),

b1_21%>%
  count(prioritario)%>%
  mutate(
    prop = round(n/sum(n),3)*100
  )%>%
  rename(var = prioritario),

b1_21%>%
  count(alto_rendimiento)%>%
  mutate(
    prop = round(n/sum(n),3)*100
  )%>%
  rename(var = alto_rendimiento))
```

```{r}
car_pos <- dplyr::bind_cols(
  pos18$var,pos18$prop,pos19$prop,pos20$prop,pos21$prop)

car_pos <- car_pos%>%
  rename(
    var = ...1,
    prop18 = ...2,
    prop19 = ...3,
    prop20 = ...4,
    prop21 = ...5)

kable(car_pos)%>%
  kable_styling(full_width = F)

#write.csv(car_pos,"C:/Users/geral/OneDrive - University of Iowa/PhD portfolio/1.-Research/2. Sistema de Admisión Escolar/car_pos.csv", row.names = FALSE)
```

```{r}
names(c1_18)
names(c1_19)
names(c1_20)
names(c1_21)

ee18 <- list(c1_18,
            c1_18%>%
            group_by(rbd)%>%
            count(rbd)%>%
            rename(demanda = n),
            
            c1_18%>%
            filter(agregada_por_continuidad == 0, preferencia_postulante == 1)%>%
            group_by(rbd)%>%
            count(rbd)%>%
            rename(first_pref = n),
            
            c1_18%>%
            filter(agregada_por_continuidad == 0, preferencia_postulante == 2)%>%
            group_by(rbd)%>%
            count(rbd)%>%
            rename(second_pref = n),
            
            c1_18%>%
            filter(agregada_por_continuidad == 0, preferencia_postulante == 3)%>%
            group_by(rbd)%>%
            count(rbd)%>%
            rename(third_pref = n)) %>% 
  reduce(left_join, by = "rbd")

c1_18%>%
  group_by(mrun)%>%
  mutate(
    prio = ifelse(prioridad_matriculado == 1 | prioridad_hermano == 1 | prioridad_hijo_funcionario == 1 | prioridad_exalumno == 1, 1,0),
    prio_sum = sum(prio)
  )%>%
  select(mrun, prioridad_matriculado:prioridad_exalumno, prio, prio_sum)%>%
  arrange(desc(prio_sum))%>%
  view()
  
c1_18%>%
  filter(mrun == 10842813)%>%
  view()
```
