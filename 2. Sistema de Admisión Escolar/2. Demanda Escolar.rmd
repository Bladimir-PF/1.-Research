---
title: "2. Demanda Escolar"
author: "GPF"
date: '2022-06-11'
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Packages
```{r}
library(tidyverse)
library(kableExtra)
library(readxl)
```

# Bases

## Oferta
```{r}
a1_18 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2018/A1_Oferta_Establecimientos_etapa_regular_2018_Admision_2019.csv")

a1_19 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2019/A1_Oferta_Establecimientos_etapa_regular_2019_Admision_2020.csv")

a1_20 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2020/A1_Oferta_Establecimientos_etapa_regular_2020_Admision_2021.csv")

a1_21 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2021/A1_Oferta_Establecimientos_etapa_regular_2021_Admision_2022.csv")
```

## Postulantes
```{r}
b1_18 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2018/B1_Postulantes_etapa_regular_2018_Admision_2019_PUBL.csv")

b1_19 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2019/B1_Postulantes_etapa_regular_2019_Admision_2020_PUBL.csv")

b1_20 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2020/B1_Postulantes_etapa_regular_2020_Admision_2021_PUBL.csv")

b1_21 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2021/B1_Postulantes_etapa_regular_2021_Admision_2022_PUBL.csv")
```

## Postulaciones
```{r}
c1_18 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2018/C1_Postulaciones_etapa_regular_2018_Admision_2019_PUBL.csv")

c1_19 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2019/C1_Postulaciones_etapa_regular_2019_Admision_2020_PUBL.csv")

c1_20 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2020/C1_Postulaciones_etapa_regular_2020_Admision_2021_PUBL.csv")

c1_21 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2021/C1_Postulaciones_etapa_regular_2021_Admision_2022_PUBL.csv")
```

## Resultados
```{r}
d1_18 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2018/D1_Resultados_etapa_regular_2018_Admision_2019_PUBL.csv")

d1_19 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2019/D1_Resultados_etapa_regular_2019_Admision_2020_PUBL.csv")

d1_20 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2020/D1_Resultados_etapa_regular_2020_Admision_2021_PUBL.csv")

d1_21 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/SAE/2021/D1_Resultados_etapa_regular_2021_Admision_2022_PUBL.csv")
```

# Manipulacion

## 2018

### Oferta
```{r}
#caso unico para rbd 2018
a1_18 <- a1_18%>%
  mutate(
    unico = duplicated(a1_18$rbd),
    unico = ifelse(unico == FALSE, 1, 0))

mat18 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/Resumen de matrícula por establecimiento/Resumen-matricula-EE-2018/Resumen_Matricula_EE_Oficial_2018.csv")

mat18 <- mat18%>%
  mutate(
    region = ifelse(NOM_COM_RBD == 'BULNES'|
NOM_COM_RBD == 'CHILLAN'|
NOM_COM_RBD == 'CHILLAN VIEJO'|
NOM_COM_RBD == 'COBQUECURA'|
NOM_COM_RBD == 'COELEMU'|
NOM_COM_RBD == 'COIHUECO'|
NOM_COM_RBD == 'EL CARMEN'|
NOM_COM_RBD == 'NINHUE'|
NOM_COM_RBD == 'ÑIQUEN'|
NOM_COM_RBD == 'PEMUCO'|
NOM_COM_RBD == 'PINTO'|
NOM_COM_RBD == 'PORTEZUELO'|
NOM_COM_RBD == 'QUILLON'|
NOM_COM_RBD == 'QUIRIHUE'|
NOM_COM_RBD == 'RANQUIL'|
NOM_COM_RBD == 'SAN CARLOS'|
NOM_COM_RBD == 'SAN FABIAN'|
NOM_COM_RBD == 'SAN IGNACIO'|
NOM_COM_RBD == 'SAN NICOLAS'|
NOM_COM_RBD == 'TREHUACO'|
NOM_COM_RBD == 'YUNGAY', 16, COD_REG_RBD))

mat18 <- mat18 %>%
  select(RBD, COD_DEPE2, RURAL_RBD, region, MAT_TOTAL)%>%
  rename(rbd = RBD, dep = COD_DEPE2, zona = RURAL_RBD, mat_total = MAT_TOTAL)

a1_18 <- left_join(a1_18, mat18, by = 'rbd')

a1_18 <- a1_18 %>%
  mutate(dep = ifelse(dep == 1 | dep == 5, 0,1))

a1_18 <- a1_18%>%
  mutate(
    macro = ifelse(region == 15 | region == 1| region == 2 | region == 3, 0,
                  ifelse(region == 4 | region == 5, 1,
                  ifelse(region == 6 | region == 7 | region == 8 |region == 16, 2,
                  ifelse(region == 9 | region == 10 | region == 14, 3,
                  ifelse(region == 11 | region == 12, 4, 5))))))

# macro
#0 = norte
#1 = centro
#2 = centro sur
#3 = sur
#4 = austral
#5 = metropolitana

dir18 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/1. Datos Abiertos MINEDUC/Directorio Establecimientos/Directorio-oficial-EE-2018/Directorio_Oficial_EE_2018.csv")

a1_18 <- left_join(a1_18, dir18%>%
  select(RBD, PAGO_MATRICULA, PAGO_MENSUAL)%>%
    rename(rbd = RBD), by = 'rbd')

a1_18 <- a1_18%>%
  mutate(PAGO_MATRICULA = ifelse(PAGO_MATRICULA == '$1.000 A $10.000' | PAGO_MATRICULA == '$10.001 A $25.000', 1,
        ifelse(PAGO_MATRICULA == '$25.001 A $50.000' | PAGO_MATRICULA == '$50.001 A $100.000', 2,
        ifelse(PAGO_MATRICULA == 'MAS DE $100.000', 3,
        ifelse(PAGO_MATRICULA == 'GRATUITO', 0, NA)))))

a1_18 <- a1_18%>%
  mutate(PAGO_MENSUAL = ifelse(PAGO_MENSUAL == '$1.000 A $10.000' | PAGO_MENSUAL == '$10.001 A $25.000', 1,
    ifelse(PAGO_MENSUAL == '$25.001 A $50.000' | PAGO_MENSUAL == '$50.001 A $100.000', 2,
    ifelse(PAGO_MENSUAL == 'MAS DE $100.000', 3, 
    ifelse(PAGO_MENSUAL == 'GRATUITO', 0, NA)))))

sep18 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/1. Datos Abiertos MINEDUC/Alumnos SEP por rbd (MINEDUC)/SEP-2018/Preferentes_Prioritarios_y_Beneficiarios_SEP_2018.csv")

a1_18 <- left_join(a1_18, sep18%>%
  select(RBD, N_PRIO)%>%
  rename(rbd = RBD), by = 'rbd')

a1_18 <- a1_18%>%
  mutate(
    prop_prio_mattotal = N_PRIO/mat_total,
    prop_prio_mattotal = ifelse(prop_prio_mattotal <= .25, 0,
                            ifelse(prop_prio_mattotal >= .251 & prop_prio_mattotal <= .5, 1,2)))

CDB2017 <- read_excel("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/2. Agencia de Calidad de la Educación/Categorías de desempeño/CDB2017.xlsx")

CDM2017 <- read_excel("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/2. Agencia de Calidad de la Educación/Categorías de desempeño/CDM2017.xlsx")

a1_18 <- data.frame(list(a1_18,
     CDB2017%>%
  select(RBD, `Categoría Desempeño 2017`)%>%
  rename(rbd = RBD, CDB_2017 = `Categoría Desempeño 2017`),
  CDM2017%>%
  select(RBD, `Categoría Desempeño 2017`)%>%
  rename(rbd = RBD, CDM_2017 = `Categoría Desempeño 2017`)
  )%>%
  reduce(left_join, by = c('rbd')))

a1_18 <- a1_18%>%
  mutate(
    CDB_2017 = ifelse(CDB_2017 == 'ALTO', 3,
                      ifelse(CDB_2017 == 'INSUFICIENTE', 0,
                             ifelse(CDB_2017 == 'MEDIO', 2,
                                    ifelse(CDB_2017 == 'MEDIO-BAJO' | CDB_2017 == 'MEDIO-BAJO (NUEVO)', 1, NA)))),
    CDM_2017 = ifelse(CDM_2017 == 'ALTO', 3,
                      ifelse(CDM_2017 == 'INSUFICIENTE', 0,
                             ifelse(CDM_2017 == 'MEDIO', 2,
                                    ifelse(CDM_2017 == 'MEDIO-BAJO' | CDM_2017 == 'MEDIO-BAJO (NUEVO)', 1, NA)))))

#0 = insuficiente
#1 = medio bajo
#2 = medio
#3 = alto

a1_18 <- data.frame(a1_18%>%
  group_by(rbd)%>%
  mutate(
    CDB_2017 = ifelse(is.na(CDB_2017), -1, CDB_2017),
    CDM_2017 = ifelse(is.na(CDM_2017), -1, CDM_2017),
    CDG = max(CDB_2017, CDM_2017),
    CDG = ifelse(CDG == -1, NA, CDG)))

a1_18 <- a1_18%>%
  mutate(
    ciclo_educativo = ifelse(cod_nivel < 1, 0,
    ifelse(cod_nivel >= 1 & cod_nivel < 9,1,2)))

remove(sep18, mat18, dir18, CDM2017, CDB2017)
```

### Postulantes
```{r}
b1_18 <- left_join(b1_18, c1_18%>%
  group_by(mrun)%>%
  summarise(continuidad = sum(prioridad_matriculado)), by = 'mrun')

b1_18 <- b1_18%>%
  mutate(
    cod_nivel = ifelse(cod_nivel < 1, 0,
    ifelse(cod_nivel == 1,1,
    ifelse(cod_nivel > 1 & cod_nivel < 9,2,
    ifelse(cod_nivel == 9, 3, 4)))))
```

### Postulaciones
```{r}
c1_18 <- data.frame(c1_18%>%
  arrange(mrun, preferencia_postulante)%>%
  group_by(mrun, rbd)%>%
    mutate(pos_valida = ifelse(duplicated(mrun, rbd) == F, 1,0)))

c1_18 <- list(c1_18,
     
c1_18%>%
  filter(pos_valida == 1, agregada_por_continuidad == 0)%>%
  group_by(rbd, cod_curso)%>%
  mutate(
    demanda_cod_curso = n())%>%
  select(rbd, cod_curso, demanda_cod_curso)%>%
  filter(duplicated(rbd, cod_curso) == F),              
                       
c1_18%>%
  filter(pos_valida == 1, agregada_por_continuidad == 0)%>%
  group_by(rbd, cod_curso)%>%
  mutate(
    first_pref = sum(preferencia_postulante == 1))%>%
  select(rbd, cod_curso, first_pref)%>%
  filter(duplicated(rbd, cod_curso) == F),

c1_18%>%
  filter(pos_valida == 1, agregada_por_continuidad == 0)%>%
  group_by(rbd, cod_curso)%>%
  mutate(
    second_pref = sum(preferencia_postulante == 2))%>%
  select(rbd, cod_curso, second_pref)%>%
  filter(duplicated(rbd, cod_curso) == F),

c1_18%>%
  filter(pos_valida == 1, agregada_por_continuidad == 0)%>%
  group_by(rbd, cod_curso)%>%
  mutate(
    third_pref = sum(preferencia_postulante == 3))%>%
  select(rbd, cod_curso, third_pref)%>%
  filter(duplicated(rbd, cod_curso) == F)) %>%
  
  reduce(left_join, by = c('rbd', 'cod_curso'))

c1_18 <- data.frame(c1_18%>%
  group_by(mrun)%>%
  mutate(
    alguna_prio = ifelse(prioridad_matriculado == 1 | prioridad_hermano == 1 | prioridad_hijo_funcionario == 1 | prioridad_exalumno == 1, 1,0),
    alguna_prio = max(alguna_prio),
    prio_colegio_origen = max(prioridad_matriculado),
    prio_fam = ifelse(prioridad_hermano == 1 | prioridad_hijo_funcionario == 1, 1,0),
    prio_fam = max(prio_fam)))
```

## 2019
```{r}
#caso unico para rbd 2019
a1_19 <- a1_19%>%
  mutate(
    unico = duplicated(a1_19$rbd),
    unico = ifelse(unico == FALSE, 1, 0))

#datos para caracterizarcion establecimientos
mat19 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/Resumen de matrícula por establecimiento/Resumen-matricula-EE-2019/Resumen_Matricula_EE_Oficial_2019.csv")

mat19 <- mat19 %>%
  select(RBD, COD_DEPE2, RURAL_RBD, COD_REG_RBD)%>%
  rename(rbd = RBD, dep = COD_DEPE2, zona = RURAL_RBD, region = COD_REG_RBD)

a1_19 <- left_join(a1_19, mat19, by = 'rbd')

a1_19 <- a1_19 %>%
  mutate(
    dep = ifelse(dep == 1 | dep == 5, 0,1)
  )

car19 <- rbind(
  
a1_19 %>%
  filter(unico == 1)%>%
  count(cod_jor)%>%
  mutate(
    prop = round(n/sum(n),3) * 100
  )%>%
  rename(var = cod_jor),

a1_19 %>%
  filter(unico == 1)%>%
  count(con_copago)%>%
  mutate(
    prop = round(n/sum(n),3) * 100
  )%>%
  rename(var = con_copago),

a1_19 %>%
  filter(unico == 1)%>%
  count(dep)%>%
  mutate(
    prop = round(n/sum(n),3) * 100
  )%>%
  rename(var = dep),

a1_19 %>%
  filter(unico == 1)%>%
  count(zona)%>%
  mutate(
    prop = round(n/sum(n),3) * 100
  )%>%
  rename(var = zona),

a1_19 %>%
  filter(unico == 1)%>%
  count(region)%>%
  mutate(
    prop = round(n/sum(n),3) * 100
  )%>%
  rename(var = region))

dir19 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/1. Datos Abiertos MINEDUC/Directorio Establecimientos/Directorio-oficial-EE-2019/Directorio_Oficial_EE_2019.csv")

a1_19 <- left_join(a1_19, dir19%>%
  select(RBD, PAGO_MATRICULA, PAGO_MENSUAL)%>%
    rename(rbd = RBD), by = 'rbd')

a1_19 <- a1_19%>%
  mutate(
    PAGO_MATRICULA = ifelse(PAGO_MATRICULA == '$1.000 A $10.000' | PAGO_MATRICULA == '$10.001 A $25.000' | PAGO_MATRICULA == '$25.001 A $50.000' | PAGO_MATRICULA == '$50.001 A $100.000' | PAGO_MATRICULA == 'MAS DE $100.000', 1, 
                            ifelse(PAGO_MATRICULA == 'GRATUITO', 0, NA)))

a1_19 <- a1_19%>%
  mutate(
    PAGO_MENSUAL = ifelse(PAGO_MENSUAL == '$1.000 A $10.000' | PAGO_MENSUAL == '$10.001 A $25.000' | PAGO_MENSUAL == '$25.001 A $50.000' | PAGO_MENSUAL == '$50.001 A $100.000' | PAGO_MENSUAL == 'MAS DE $100.000', 1, 
                            ifelse(PAGO_MENSUAL == 'GRATUITO', 0, NA)))

sep19 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/1. Datos Abiertos MINEDUC/Alumnos SEP por rbd (MINEDUC)/SEP-2019/Preferentes_Prioritarios_y_Beneficiarios_SEP_2019.csv")

a1_19 <- left_join(a1_19, sep19%>%
  select(RBD, N_PRIO)%>%
  rename(rbd = RBD), by = 'rbd')

a1_19 <- left_join(a1_19, mat19%>%
  select(RBD, MAT_TOTAL)%>%
  rename(rbd = RBD, mat_total = MAT_TOTAL), by = 'rbd')

a1_19 <- a1_19%>%
  mutate(
    prop_prio_mattotal = N_PRIO/mat_total,
    prop_prio_mattotal = ifelse(prop_prio_mattotal <= .25, 0,
                            ifelse(prop_prio_mattotal >= .251 & prop_prio_mattotal <= .5, 1,2)))

CDB2018 <- read_excel("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/2. Agencia de Calidad de la Educación/Categorías de desempeño/CDB2018.xlsx")

CDM2018 <- read_excel("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/2. Agencia de Calidad de la Educación/Categorías de desempeño/CDM2018.xlsx")

pos19 <- rbind(b1_19%>%
  count(cod_nivel)%>%
  mutate(
    prop = round(n/sum(n),3)*100
  )%>%
  rename(var = cod_nivel),

b1_19%>%
  count(es_mujer)%>%
  mutate(
    prop = round(n/sum(n),3)*100
  )%>%
  rename(var = es_mujer),

b1_19%>%
  count(prioritario)%>%
  mutate(
    prop = round(n/sum(n),3)*100
  )%>%
  rename(var = prioritario),

b1_19%>%
  count(alto_rendimiento)%>%
  mutate(
    prop = round(n/sum(n),3)*100
  )%>%
  rename(var = alto_rendimiento))

c1_19 <- left_join(c1_19, c1_19%>%
  count(mrun, rbd)%>%
  rename(repeticiones = n))

c1_19 <- data.frame(c1_19%>%
  arrange(mrun, preferencia_postulante)%>%
  group_by(mrun, rbd)%>%
    mutate(
      pos_valida = ifelse(duplicated(mrun, rbd) == F, 1,0)
      ))

c1_19 <- list(c1_19,
              
c1_19%>%
  filter(pos_valida == 1, agregada_por_continuidad == 0)%>%
  group_by(rbd, cod_curso)%>%
  mutate(
    demanda = n())%>%
  select(rbd, cod_curso, demanda),

c1_19%>%
  filter(pos_valida == 1, agregada_por_continuidad == 0)%>%
  group_by(rbd, cod_curso)%>%
  mutate(
    first_pref = sum(preferencia_postulante == 1))%>%
  select(rbd, cod_curso, first_pref),

c1_19%>%
  filter(pos_valida == 1, agregada_por_continuidad == 0)%>%
  group_by(rbd, cod_curso)%>%
  mutate(
    second_pref = sum(preferencia_postulante == 2))%>%
  select(rbd, cod_curso, second_pref),

c1_19%>%
  filter(pos_valida == 1, agregada_por_continuidad == 0)%>%
  group_by(rbd, cod_curso)%>%
  mutate(
    third_pref = sum(preferencia_postulante == 3))%>%
  select(rbd, cod_curso, third_pref)) %>%
  
  reduce(left_join, by = c('mrun', 'rbd'))

c1_19 <- data.frame(c1_19%>%
  group_by(mrun)%>%
  mutate(
    
    alguna_prio = ifelse(prioridad_matriculado == 1 | prioridad_hermano == 1 | prioridad_hijo_funcionario == 1 | prioridad_exalumno == 1, 1,0),
    alguna_prio = max(alguna_prio),
    
    prio_colegio_origen = max(prioridad_matriculado),
    
    prio_fam = ifelse(prioridad_hermano == 1 | prioridad_hijo_funcionario == 1, 1,0),
    prio_fam = max(prio_fam)))

a1_19%>%
  drop_na()%>%
  group_by(prop_prio_mattotal)%>%
  summarise(
    s = sum(demanda_cod_curso))%>%
  mutate(
    prop = round(s/sum(s),3)*100
  )

a1_19%>%
  group_by(con_copago)%>%
  summarise(
    s = sum(demanda_cod_curso))%>%
  mutate(
    prop = round(s/sum(s),3)*100
  )

a1_19%>%
  drop_na()%>%
  group_by(dep)%>%
  summarise(
    s = sum(demanda_cod_curso))%>%
  mutate(
    prop = round(s/sum(s),3)*100
  )

b1_19 <- left_join(b1_19, c1_19%>%
  group_by(mrun)%>%
  summarise(continuidad = sum(prioridad_matriculado)), by = 'mrun')


b1_20 <- left_join(b1_20, c1_20%>%
  group_by(mrun)%>%
  summarise(continuidad = sum(prioridad_matriculado)), by = 'mrun')

```

## 2020
```{r}
# Caso unico para rbd 2020
a1_20 <- a1_20%>%
  mutate(
    unico = duplicated(a1_20$rbd),
    unico = ifelse(unico == FALSE, 1, 0))

# datos para caracterizarcion establecimientos
mat20 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/Resumen de matrícula por establecimiento/Resumen-matricula-EE-2020/Resumen_Matricula_EE_Oficial_2020.csv")

mat20 <- mat20 %>%
  select(RBD, COD_DEPE2, RURAL_RBD, COD_REG_RBD)%>%
  rename(rbd = RBD, dep = COD_DEPE2, zona = RURAL_RBD, region = COD_REG_RBD)

a1_20 <- left_join(a1_20, mat20, by = 'rbd')

a1_20 <- a1_20 %>%
  mutate(
    dep = ifelse(dep == 1 | dep == 5, 0,1)
  )

# 2020
car20 <- rbind(
  
a1_20 %>%
  filter(unico == 1)%>%
  count(cod_jor)%>%
  mutate(
    prop = round(n/sum(n),3) * 100
  )%>%
  rename(var = cod_jor),

a1_20 %>%
  filter(unico == 1)%>%
  count(con_copago)%>%
  mutate(
    prop = round(n/sum(n),3) * 100
  )%>%
  rename(var = con_copago),

a1_20 %>%
  filter(unico == 1)%>%
  count(dep)%>%
  mutate(
    prop = round(n/sum(n),3) * 100
  )%>%
  rename(var = dep),

a1_20 %>%
  filter(unico == 1)%>%
  count(zona)%>%
  mutate(
    prop = round(n/sum(n),3) * 100
  )%>%
  rename(var = zona),

a1_20 %>%
  filter(unico == 1)%>%
  count(region)%>%
  mutate(
    prop = round(n/sum(n),3) * 100
  )%>%
  rename(var = region))

dir20 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/1. Datos Abiertos MINEDUC/Directorio Establecimientos/Directorio-oficial-EE-2020/Directorio_Oficial_EE_2020.csv")

a1_20 <- left_join(a1_20, dir20%>%
  select(RBD, PAGO_MATRICULA, PAGO_MENSUAL)%>%
    rename(rbd = RBD), by = 'rbd')

a1_20 <- a1_20%>%
  mutate(
    PAGO_MATRICULA = ifelse(PAGO_MATRICULA == '$1.000 A $10.000' | PAGO_MATRICULA == '$10.001 A $25.000' | PAGO_MATRICULA == '$25.001 A $50.000' | PAGO_MATRICULA == '$50.001 A $100.000' | PAGO_MATRICULA == 'MAS DE $100.000', 1, 
                            ifelse(PAGO_MATRICULA == 'GRATUITO', 0, NA)))

a1_20 <- a1_20%>%
  mutate(
    PAGO_MENSUAL = ifelse(PAGO_MENSUAL == '$1.000 A $10.000' | PAGO_MENSUAL == '$10.001 A $25.000' | PAGO_MENSUAL == '$25.001 A $50.000' | PAGO_MENSUAL == '$50.001 A $100.000' | PAGO_MENSUAL == 'MAS DE $100.000', 1, 
                            ifelse(PAGO_MENSUAL == 'GRATUITO', 0, NA)))

sep20 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/1. Datos Abiertos MINEDUC/Alumnos SEP por rbd (MINEDUC)/SEP-2020/Preferentes_Prioritarios_y_Beneficiarios_SEP_2020.csv")

a1_20 <- left_join(a1_20, sep20%>%
  select(RBD, N_PRIO)%>%
  rename(rbd = RBD), by = 'rbd')

a1_20 <- left_join(a1_20, mat20%>%
  select(RBD, MAT_TOTAL)%>%
  rename(rbd = RBD, mat_total = MAT_TOTAL), by = 'rbd')

a1_20 <- a1_20%>%
  mutate(
    prop_prio_mattotal = N_PRIO/mat_total,
    prop_prio_mattotal = ifelse(prop_prio_mattotal <= .25, 0,
                            ifelse(prop_prio_mattotal >= .251 & prop_prio_mattotal <= .5, 1,2)))

CDM2019 <- read_excel("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/2. Agencia de Calidad de la Educación/Categorías de desempeño/CDM2019.xlsx")

CDB2019 <- read_excel("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/2. Agencia de Calidad de la Educación/Categorías de desempeño/CDB2019.xlsx")

pos20 <- rbind(b1_20%>%
  count(cod_nivel)%>%
  mutate(
    prop = round(n/sum(n),3)*100
  )%>%
  rename(var = cod_nivel),

b1_20%>%
  count(es_mujer)%>%
  mutate(
    prop = round(n/sum(n),3)*100
  )%>%
  rename(var = es_mujer),

b1_20%>%
  count(prioritario)%>%
  mutate(
    prop = round(n/sum(n),3)*100
  )%>%
  rename(var = prioritario),

b1_20%>%
  count(alto_rendimiento)%>%
  mutate(
    prop = round(n/sum(n),3)*100
  )%>%
  rename(var = alto_rendimiento))

#2020

c1_20 <- left_join(c1_20, c1_20%>%
  count(mrun, rbd)%>%
  rename(repeticiones = n))

c1_20 <- data.frame(c1_20%>%
  arrange(mrun, preferencia_postulante)%>%
  group_by(mrun, rbd)%>%
    mutate(
      pos_valida = ifelse(duplicated(mrun, rbd) == F, 1,0)
      ))

c1_20 <- list(c1_20,
              
c1_20%>%
  filter(pos_valida == 1, agregada_por_continuidad == 0)%>%
  group_by(rbd, cod_curso)%>%
  mutate(
    demanda = n())%>%
  select(rbd, cod_curso, demanda),

c1_20%>%
  filter(pos_valida == 1, agregada_por_continuidad == 0)%>%
  group_by(rbd, cod_curso)%>%
  mutate(
    first_pref = sum(preferencia_postulante == 1))%>%
  select(rbd, cod_curso, first_pref),

c1_20%>%
  filter(pos_valida == 1, agregada_por_continuidad == 0)%>%
  group_by(rbd, cod_curso)%>%
  mutate(
    second_pref = sum(preferencia_postulante == 2))%>%
  select(rbd, cod_curso, second_pref),

c1_20%>%
  filter(pos_valida == 1, agregada_por_continuidad == 0)%>%
  group_by(rbd, cod_curso)%>%
  mutate(
    third_pref = sum(preferencia_postulante == 3))%>%
  select(rbd, cod_curso, third_pref)) %>%
  
  reduce(left_join, by = c('mrun', 'rbd'))

c1_20 <- data.frame(c1_20%>%
  group_by(mrun)%>%
  mutate(
    
    alguna_prio = ifelse(prioridad_matriculado == 1 | prioridad_hermano == 1 | prioridad_hijo_funcionario == 1 | prioridad_exalumno == 1, 1,0),
    alguna_prio = max(alguna_prio),
    
    prio_colegio_origen = max(prioridad_matriculado),
    
    prio_fam = ifelse(prioridad_hermano == 1 | prioridad_hijo_funcionario == 1, 1,0),
    prio_fam = max(prio_fam)))

#2020
a1_20%>%
  drop_na()%>%
  group_by(prop_prio_mattotal)%>%
  summarise(
    s = sum(demanda_cod_curso))%>%
  mutate(
    prop = round(s/sum(s),3)*100
  )

a1_20%>%
  group_by(con_copago)%>%
  summarise(
    s = sum(demanda_cod_curso))%>%
  mutate(
    prop = round(s/sum(s),3)*100
  )

a1_20%>%
  drop_na()%>%
  group_by(dep)%>%
  summarise(
    s = sum(demanda_cod_curso))%>%
  mutate(
    prop = round(s/sum(s),3)*100
  )



```

## 2021
```{r}
#Caso unico para rbd 2021
a1_21 <- a1_21%>%
  mutate(
    unico = duplicated(a1_21$rbd),
    unico = ifelse(unico == FALSE, 1, 0))

#datos para caracterizarcion establecimientos
mat21 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/Resumen de matrícula por establecimiento/Resumen-matricula-EE-2021/Resumen_Matricula_EE_Oficial_2021.csv")

mat21 <- mat21 %>%
  select(RBD, COD_DEPE2, RURAL_RBD, COD_REG_RBD)%>%
  rename(rbd = RBD, dep = COD_DEPE2, zona = RURAL_RBD, region = COD_REG_RBD)

a1_21 <- left_join(a1_21, mat21, by = 'rbd')

a1_21 <- a1_21 %>%
  mutate(
    dep = ifelse(dep == 1 | dep == 5, 0,1)
  )

# 2021
car21 <- rbind(
  
a1_21 %>%
  filter(unico == 1)%>%
  count(cod_jor)%>%
  mutate(
    prop = round(n/sum(n),3) * 100
  )%>%
  rename(var = cod_jor),

a1_21 %>%
  filter(unico == 1)%>%
  count(con_copago)%>%
  mutate(
    prop = round(n/sum(n),3) * 100
  )%>%
  rename(var = con_copago),

a1_21 %>%
  filter(unico == 1)%>%
  count(dep)%>%
  mutate(
    prop = round(n/sum(n),3) * 100
  )%>%
  rename(var = dep),

a1_21 %>%
  filter(unico == 1)%>%
  count(zona)%>%
  mutate(
    prop = round(n/sum(n),3) * 100
  )%>%
  rename(var = zona),

a1_21 %>%
  filter(unico == 1)%>%
  count(region)%>%
  mutate(
    prop = round(n/sum(n),3) * 100
  )%>%
  rename(var = region))

dir21 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/1. Datos Abiertos MINEDUC/Directorio Establecimientos/Directorio-oficial-EE-2021/Directorio_Oficial_EE_2021.csv")

a1_21 <- left_join(a1_21, dir21%>%
  select(RBD, PAGO_MATRICULA, PAGO_MENSUAL)%>%
    rename(rbd = RBD), by = 'rbd')

a1_21 <- a1_21%>%
  mutate(
    PAGO_MATRICULA = ifelse(PAGO_MATRICULA == '$1.000 A $10.000' | PAGO_MATRICULA == '$10.001 A $25.000' | PAGO_MATRICULA == '$25.001 A $50.000' | PAGO_MATRICULA == '$50.001 A $100.000' | PAGO_MATRICULA == 'MAS DE $100.000', 1, 
                            ifelse(PAGO_MATRICULA == 'GRATUITO', 0, NA)))

a1_21 <- a1_21%>%
  mutate(
    PAGO_MENSUAL = ifelse(PAGO_MENSUAL == '$1.000 A $10.000' | PAGO_MENSUAL == '$10.001 A $25.000' | PAGO_MENSUAL == '$25.001 A $50.000' | PAGO_MENSUAL == '$50.001 A $100.000' | PAGO_MENSUAL == 'MAS DE $100.000', 1, 
                            ifelse(PAGO_MENSUAL == 'GRATUITO', 0, NA)))

sep21 <- read.csv2("C:/Users/geral/OneDrive - University of Iowa/CIDCIE/1. Bases de Datos/1. Datos Abiertos MINEDUC/Alumnos SEP por rbd (MINEDUC)/SEP-2021/Preferentes_Prioritarios_y_Beneficiarios_SEP_2021.csv")

a1_21 <- left_join(a1_21, sep21%>%
  select(RBD, N_PRIO)%>%
  rename(rbd = RBD), by = 'rbd')
  
a1_21 <- left_join(a1_21, mat21%>%
  select(RBD, MAT_TOTAL)%>%
  rename(rbd = RBD, mat_total = MAT_TOTAL), by = 'rbd')

a1_21 <- a1_21%>%
  mutate(
    prop_prio_mattotal = N_PRIO/mat_total,
    prop_prio_mattotal = ifelse(prop_prio_mattotal <= .25, 0,
                            ifelse(prop_prio_mattotal >= .251 & prop_prio_mattotal <= .5, 1,2)))

pos21 <- rbind(b1_21%>%
  count(cod_nivel)%>%
  mutate(
    prop = round(n/sum(n),3)*100
  )%>%
  rename(var = cod_nivel),

b1_21%>%
  count(es_mujer)%>%
  mutate(
    prop = round(n/sum(n),3)*100
  )%>%
  rename(var = es_mujer),

b1_21%>%
  count(prioritario)%>%
  mutate(
    prop = round(n/sum(n),3)*100
  )%>%
  rename(var = prioritario),

b1_21%>%
  count(alto_rendimiento)%>%
  mutate(
    prop = round(n/sum(n),3)*100
  )%>%
  rename(var = alto_rendimiento))

# 2021

c1_21 <- left_join(c1_21, c1_21%>%
  count(mrun, rbd)%>%
  rename(repeticiones = n))

c1_21 <- data.frame(c1_21%>%
  arrange(mrun, preferencia_postulante)%>%
  group_by(mrun, rbd)%>%
    mutate(
      pos_valida = ifelse(duplicated(mrun, rbd) == F, 1,0)
      ))

c1_21 <- list(c1_21,
              
c1_21%>%
  filter(pos_valida == 1, agregada_por_continuidad == 0)%>%
  group_by(rbd, cod_curso)%>%
  mutate(
    demanda = n())%>%
  select(rbd, cod_curso, demanda),

c1_21%>%
  filter(pos_valida == 1, agregada_por_continuidad == 0)%>%
  group_by(rbd, cod_curso)%>%
  mutate(
    first_pref = sum(preferencia_postulante == 1))%>%
  select(rbd, cod_curso, first_pref),

c1_21%>%
  filter(pos_valida == 1, agregada_por_continuidad == 0)%>%
  group_by(rbd, cod_curso)%>%
  mutate(
    second_pref = sum(preferencia_postulante == 2))%>%
  select(rbd, cod_curso, second_pref),

c1_21%>%
  filter(pos_valida == 1, agregada_por_continuidad == 0)%>%
  group_by(rbd, cod_curso)%>%
  mutate(
    third_pref = sum(preferencia_postulante == 3))%>%
  select(rbd, cod_curso, third_pref)) %>%
  
  reduce(left_join, by = c('mrun', 'rbd'))

c1_21 <- data.frame(c1_21%>%
  group_by(mrun)%>%
  mutate(
    
    alguna_prio = ifelse(prioridad_matriculado == 1 | prioridad_hermano == 1 | prioridad_hijo_funcionario == 1 | prioridad_exalumno == 1, 1,0),
    alguna_prio = max(alguna_prio),
    
    prio_colegio_origen = max(prioridad_matriculado),
    
    prio_fam = ifelse(prioridad_hermano == 1 | prioridad_hijo_funcionario == 1, 1,0),
    prio_fam = max(prio_fam)))

# 2021
a1_21%>%
  drop_na()%>%
  group_by(prop_prio_mattotal)%>%
  summarise(
    s = sum(demanda_cod_curso))%>%
  mutate(
    prop = round(s/sum(s),3)*100
  )

a1_21%>%
  group_by(con_copago)%>%
  summarise(
    s = sum(demanda_cod_curso))%>%
  mutate(
    prop = round(s/sum(s),3)*100
  )

a1_21%>%
  drop_na()%>%
  group_by(dep)%>%
  summarise(
    s = sum(demanda_cod_curso))%>%
  mutate(
    prop = round(s/sum(s),3)*100
  )

# categoria de desempeño general

#2018
a1_18%>%
  drop_na()%>%
  group_by(CDG)%>%
  summarise(
    s = sum(demanda_cod_curso))%>%
  mutate(
    prop = round(s/sum(s),3)*100
  )

b1_21 <- left_join(b1_21, c1_21%>%
  group_by(mrun)%>%
  summarise(continuidad = sum(prioridad_matriculado)), by = 'mrun')
```

# Tabla 1
```{r}
#2018
a1_18 %>%
  filter(unico == 1)%>%
  count(cod_jor)%>%
  mutate(prop = round(n/sum(n),3) * 100)

a1_18 %>%
  filter(unico == 1)%>%
  count(con_copago)%>%
  mutate(prop = round(n/sum(n),3) * 100)

a1_18 %>%
  filter(unico == 1)%>%
  count(dep)%>%
  mutate(prop = round(n/sum(n),3) * 100)

a1_18 %>%
  filter(unico == 1)%>%
  count(zona)%>%
  mutate(prop = round(n/sum(n),3) * 100)

a1_18 %>%
  filter(unico == 1)%>%
  count(macro)%>%
  mutate(prop = round(n/sum(n),3) * 100)
```

# Tabla 2
```{r}
#2018
b1_18%>%
  count(cod_nivel)%>%
  mutate(prop = round(n/sum(n),3)*100)

b1_18%>%
  count(es_mujer)%>%
  mutate(prop = round(n/sum(n),3)*100)

b1_18%>%
  count(prioritario)%>%
  mutate(prop = round(n/sum(n),3)*100)

b1_18%>%
  count(alto_rendimiento)%>%
  mutate(prop = round(n/sum(n),3)*100)

b1_18%>%
  count(continuidad)%>%
  mutate(prop = round(n/sum(n),3)*100)

#2019
b1_19%>%
  count(cod_nivel)%>%
  mutate(prop = round(n/sum(n),3)*100)

b1_19%>%
  count(es_mujer)%>%
  mutate(prop = round(n/sum(n),3)*100)

b1_19%>%
  count(prioritario)%>%
  mutate(prop = round(n/sum(n),3)*100)

b1_19%>%
  count(alto_rendimiento)%>%
  mutate(prop = round(n/sum(n),3)*100)

b1_19%>%
  count(continuidad)%>%
  mutate(prop = round(n/sum(n),3)*100)

b1_19%>%
  count(continuidad)%>%
  mutate(prop = round(n/sum(n),3)*100)

#2020
b1_20%>%
  count(cod_nivel)%>%
  mutate(prop = round(n/sum(n),3)*100)

b1_20%>%
  count(es_mujer)%>%
  mutate(prop = round(n/sum(n),3)*100)

b1_20%>%
  count(prioritario)%>%
  mutate(prop = round(n/sum(n),3)*100)

b1_20%>%
  count(alto_rendimiento)%>%
  mutate(prop = round(n/sum(n),3)*100)

b1_20%>%
  count(continuidad)%>%
  mutate(prop = round(n/sum(n),3)*100)

b1_20%>%
  count(continuidad)%>%
  mutate(prop = round(n/sum(n),3)*100)

#2021
b1_21%>%
  count(cod_nivel)%>%
  mutate(prop = round(n/sum(n),3)*100)

b1_21%>%
  count(es_mujer)%>%
  mutate(prop = round(n/sum(n),3)*100)

b1_21%>%
  count(prioritario)%>%
  mutate(prop = round(n/sum(n),3)*100)

b1_21%>%
  count(alto_rendimiento)%>%
  mutate(prop = round(n/sum(n),3)*100)

b1_21%>%
  count(continuidad)%>%
  mutate(prop = round(n/sum(n),3)*100)

b1_21%>%
  count(continuidad)%>%
  mutate(prop = round(n/sum(n),3)*100)
```